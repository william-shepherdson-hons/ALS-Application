name: Build and test

on:
  push:
    branches: [ "main", "updating-cicd" ]

env:
  CARGO_TERM_COLOR: always

jobs:

  # ---------------------------------
  # Self-hosted ARM builds (Linux ARM + Windows)
  # ---------------------------------
  Build-Tauri-Linux-ARM-Windows:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /home/dietpi/ALS-Application/
    steps:
      - uses: actions/checkout@v3

      - name: Add cargo to PATH
        run: echo "PATH=/home/dietpi/.cargo/bin:$PATH" >> $GITHUB_ENV

      - name: Install Node dependencies
        run: npm install

      - name: Build Tauri Linux ARM
        run: npm run tauri build

      - name: Build Tauri Windows x86_64
        run: npm run tauri build -- --runner cargo-xwin --target x86_64-pc-windows-msvc

      - name: Collect ARM & Windows artifacts
        run: |
          mkdir -p artifacts
          # Linux ARM
          cp src-tauri/target/release/bundle/*/* artifacts/ || true
          # Windows
          cp src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe artifacts/ || true

      - name: Upload ARM & Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: elearningplatform-arm-windows
          path: artifacts

  # ---------------------------------
  # GitHub-hosted Linux x86_64 build
  # ---------------------------------
  Build-Tauri-Linux-x86_64:
    runs-on: ubuntu-latest
    needs: Build-Tauri-Linux-ARM-Windows
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install dependencies
        run: npm install

      - name: Build Tauri Linux x86_64
        run: npm run tauri build -- --target x86_64-unknown-linux-gnu

      - name: Collect x86_64 artifact
        run: |
          mkdir -p artifacts
          cp src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/*/* artifacts/ || true

      - name: Upload x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: elearningplatform-x86_64
          path: artifacts

  # ---------------------------------
  # Combine all three artifacts
  # ---------------------------------
  Combine-Artifacts:
    runs-on: ubuntu-latest
    needs:
      - Build-Tauri-Linux-ARM-Windows
      - Build-Tauri-Linux-x86_64
    steps:
      - name: Download ARM & Windows artifact
        uses: actions/download-artifact@v5
        with:
          name: elearningplatform-arm-windows
          path: combined-artifacts

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v5
        with:
          name: elearningplatform-x86_64
          path: combined-artifacts

      - name: Repackage all builds
        run: |
          mkdir -p artifacts
          cp -r combined-artifacts/* artifacts/

      - name: Upload final combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: elearningplatform
          path: artifacts
